# DNS 因特网的目录服务
因特网上的主机和人类一样，可以使用很多方式进行标识。一种方法是用它的主机名（hostname），如 www.baidu.com，这些名字便于记忆。
然而，主机名几乎没有提供关于主机在网络中的信息。所以，主机也可以使用 IP 地址进行标识。

### DNS 提供的服务
我们知道识别主机可以有两种方式：主机名和 IP 地址。人们喜欢便于记忆的主机名，而路由器喜欢定长的、有层次结构的 IP 地址。
我们需要能进行主机名到IP地址转换的目录服务，也就是域名系统（Domain Name System， DNS）。DNS是：
* 一个由分层的DNS服务器实现的分布式数据库
* 使主机能够查询分布式数据库的应用层协议

#### 实践原则
>DNS 与 HTTP、FTP、SMTP 协议一样，是一个应用层协议，原因在于：1、使用客户-服务器模式运行在通信的端系统之间； 2、在通信的端系统之间通过端到端协议来传输DNS报文。

>DNS通过采用了位于网络边缘的客户和服务器，实现了关键的名字到地址转换功能。

看一个例子，用户发送一个HTTP请求报文到Web服务器 www.baidu.com/search&key=dog，则用户首先应该获取改服务器的IP地址：
* 用户主机上运行着DNS应用的客户端
* 浏览器从上述URL抽取出主机名：www.baidu.com，并将主机名传给DNS应用的客户端
* DNS客户端向DNS 服务器发送一个包含主机名的请求
* DNS 客户端最终会收到一份回答报文，其中含有目标主机的IP地址
* 浏览器向改IP地址80端口的HTTP服务器进程发起一个TCP连接

可以注意到，DNS给使用它的因特网应用带来了额外的延时，但幸运的是，想要获得的IP地址通常就缓存在“附近的”DNS服务器中。

#### DNS提供的其他服务
* 主机别名：有着复制主机名的主机能拥有一个或多个别名，如 www.baidu.com 和 baidu.com。应用程序可以调用DNS来获取主机别名对应的主机名和IP地址。
也就是说，多个域名可以映射到同一个IP地址
* 邮件服务器别名：类似于主机别名
* 负载分配：繁忙的站点被冗余地分布在多台服务器上，每台服务器运行在不同的端系统上，并且有不同的IP地址，所以同一个规范主机名可能对应了多个IP地址。DNS数据库中储着这这些IP地址集合。
当客户对改域名发起DNS请求时，该服务器用IP地址的整个集合进行响应，但在每个回答中循环这些地址的次序响应。因为客户通常总是用IP地址排在最前面的服务器发送HTTP报文，所以DNS就在所以这些冗余的服务器之间循环分配了负载。
                            
### DNS 工作机理概述                              
>DNS请求和问答都是 UDP 数据报，并且经过端口53发送。                                                     

DNS的一种简单设计师在因特网上只使用一个DNS服务器，该服务器包含所有的 域名-IP 映射。客户直接将所有查询发往单一的DNS服务器。但因为如今因特网主机数量巨大，这种方案有很大的弊端：
* **单点故障**。如果该DNS服务器崩溃，整个互联网也瘫痪
* **通信容量**。单个服务器不得不处理所有的DNS查询
* **远距离的集中式数据库**。会带来严重的时延
* **不可维护**

总的来说，单一DNS 服务器上运行集中式数据库完全没有可扩展能力，因此采用分布式设计方案。
![](https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1509033021402&di=84226061870bad006f5f76e0e6367554&imgtype=0&src=http%3A%2F%2Fs3.51cto.com%2Fwyfs02%2FM02%2F5D%2FB5%2FwKioL1Ujm6DTDAHCAADU75CZLqc087.jpg)

#### 分布式、层次数据库
为了处理可扩展问题，使用了大量的服务器，并且以层次方式组织。如上图。
大致来说，有三只类型的DNS服务器：
* 根DNS服务器。一共有13个根DNS服务器，尽管把根服务器视为单个的服务器，但是每一个根都是一个冗余服务器的网络
* 顶级域DNS服务器。Top-Level Domain，TLD。如：com、org、net、edu、gov，和一些国家的顶级域名如：uk、cn、us...
* 权威DNS服务器。在因特网上具有公共可访问主机的每个机构必须提供公共可访问的DNS记录，这些记录将这些主机的名字映射为IP地址。

![](https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=166528593,3107293947&fm=27&gp=0.jpg)

除了以上所示，还有另一类重要的DNS，称为本地DNS服务器。本地DNS服务器严格来说不属于该服务器的层次结构，但它对DNS的结构很重要。每个ISP（Internet Service Provider）如一个大学、公司的ISP都有一台本地DNS服务器。
当主机与某个ISP连接时，该主机具有一台或多台其本地DNS服务器IP地址（通常通过DHCP）。
当主机发出DNS请求，该请求被发往本地DNS服务器（代理作用），并将该请求转发到DNS服务器层次结构中。

#### DNS 缓存
为了改善时延性能并减少在因特网上到处传输的DNS数量，DNS广泛采用了缓存技术。在一个请求链中，当某个DNS服务器接收一个DNS的回答时，他能够将该回答中的信息缓存到本机储存器。另一个对相同主机名的查询到达该DNS服务器时，该服务器自己就能够提供IP地址，即便它不是该主机名的权威服务器。
由于主机和主机名与IP地址的映射不是永久的，DNS服务器在一段时间后（通常为两天）将丢弃缓存的信息。

因为有了缓存，该本地DNS服务器大多时候可以立即返回需要的IP地址，而不必查询任何其他DNS服务器。本地DNS服务器也能够缓存TLD服务器的IP地址，因而允许本地DNS绕过查询链中的根DNS服务器。

### DNS报文和记录
这部分内容没有什么好说的，基本上是对每一行报文意义的说明。有兴趣的同学可以自行了解。

### 安全性
DNS是因特网上如此重要的组件，以至于没有它整个网络都会瘫痪。那么DNS是一个容易受到攻击的目标吗？攻击方式有哪些呢？
* 分布式拒绝服务带宽洪泛攻击。。。好长的名字。大概就是攻击者向每个根服务器发送大量的分组，增大根服务器压力，使大多数合法请求得不到回答。
不过，许多根服务器都有分组过滤器的保护，阻挡所有指向根服务器的ICMP ping 报文。基本没有太大伤害。

* 中间人攻击。攻击者向一台DNS服务器发送伪造的回答，使DNS服务器缓存错误的信息。不过这种攻击难度太大。。。

总而言之，DNS的健壮性还是很令人惊讶的。通过适当的配置DNS服务器，能够处理这些攻击。